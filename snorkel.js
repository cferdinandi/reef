/*! ReefSnorkel v8.2.0 | (c) 2021 Chris Ferdinandi | MIT License | http://github.com/cferdinandi/reef */
"use strict";let e,t,n=new Map;function o(e,t){let o=n.get(e);if(o&&!(o.timestamp+t>(new Date).getTime()))return o.html;n.delete(e)}function i(){n.clear(),e.emit(document,"snorkel:cache-cleared",this)}function c(e,t){return e.pathname===window.location.pathname&&e.search===window.location.search}function r(e,t,n){history[n?"replaceState":"pushState"]({url:e},t,e)}function l(n,o){let i=(c=n,(new DOMParser).parseFromString(c,"text/html"));var c;let{noPush:l,replace:a,url:s,current:u,components:d}=o;!function(e,n){document.documentElement.classList.add(n.loading),t(e.head,document.head),document.body.replaceWith(e.body),window.scrollTo(0,0),document.documentElement.classList.remove(n.loading)}(i,o),l||r(s,i.title,a),function(e){e.forEach((function(e){"render"in e&&e.render()}))}(d),function(e){if(!e)return;let t=document.getElementById(e.slice(1));t&&(t.scrollIntoView(),document.activeElement!==t&&(t.setAttribute("tabindex","-1"),t.focus()))}(window.location.hash),function(t,n){e.emit(document,"snorkel:after",{current:t,previous:n})}(s,u)}function a(t,i){let c=window.location.href;Object.assign(i,{current:c,url:t});let{cacheTime:r,cacheSize:a}=i;if(!!function(t,n){return e.emit(document,"snorkel:before",{current:t,next:n})}(c,t)){if(r){let e=o(t,r);if(e)return void l(e,i)}fetch(t).then((function(e){if(e.ok)return e.text();throw e.statusText})).then((function(o){l(o,i),function(t,o,i){n.set(t,{html:o,timestamp:(new Date).getTime()}),e.emit(document,"snorkel:cache-updated",{url:t,html:o}),n.size>i&&n.delete(keys().next().value)}(t,o,a)})).catch((function(n){Reef.err(n,!0),function(t,n){e.emit(document,"snorkel:not-found",{current:t,notFound:n})}(c,t)}))}}function s(e){return function(t){!function(e,t){if(e.metaKey||e.ctrlKey||e.shiftKey||e.defaultPrevented)return;let n=function(e){if("closest"in e.target)return e.target.closest("a")}(e);if(!n||n.host!==window.location.host||n.hasAttribute("download")||"external"===n.getAttribute("rel")||n.href.includes("mailto:")||!n.pathname.startsWith(t._root))return;let o=n.closest(t._follow),i=n.closest(t._ignore);(!i||o&&i.contains(o))&&(o||t._autoLinks)&&(c(n)&&n.hash.length||(e.preventDefault(),a(n.href,{replace:n.closest(t._replace),cacheSize:t._cacheSize,components:t._components,loading:t._loading})))}(t,e)}}function u(e){return function(t){!function(e,t){if(!e.state)return void r(window.location.href,document.title,!0);let n=new URL(e.state.url);c(n)&&n.hash.length||a(e.state.url,{noPush:!0,cacheTime:!!t._cache&&t._cacheTime,components:t._components,loading:t._loading})}(t,e)}}let d,f,h={autoLinks:!0,follow:"[snorkel]",ignore:"[snorkel-ignore]",replace:'[snorkel="replace"]',loading:"reef-loading",root:"/",cache:!0,cacheSize:50,cacheTime:3600,components:[]},m=!1;function p(n={}){if(!e||!t||!e.err)throw new Error("Reef not found. Use Reef.use(ReefSnorkel) to install this plugin.");let o=Object.assign({},h,n);Object.defineProperties(this,{_autoLinks:{value:o.autoLinks},_follow:{value:o.follow},_ignore:{value:o.ignore},_replace:{value:o.replace},_root:{value:o.root},_cache:{value:o.cache},_cacheSize:{value:1e3*o.cacheSize},_cacheTime:{value:o.cacheTime},_loading:{value:o.loading},_components:{get:function(){return o.components}}}),this.run()}p.prototype.run=function(){m&&(e.err("An instance of ReefSnorkel was already running, and has been stopped."),m.stop()),d=s(this),f=u(this),history.replaceState({url:window.location.href},document.title,window.location.href),document.addEventListener("click",d),window.addEventListener("popstate",f),m=this,e.emit(document,"snorkel:initialized",this)},p.prototype.stop=function(){document.removeEventListener("click",d),window.removeEventListener("popstate",f),i(),d=null,f=null,m=!1,e.emit(document,"snorkel:stopped",this)},p.prototype.visit=function(e,t){a(e,{replace:t,cacheSize:this._cacheSize,components:this._components,loading:this._loading})},p.prototype.clearCache=function(){i()},p.prototype.addComponent=function(t){let n="array"===e.trueTypeOf(t)?t:[t];for(let e of n)this._components.push(e);e.emit(document,"snorkel:components-added",{snorkel:this,components:n})},p.prototype.removeComponent=function(t){let n="array"===e.trueTypeOf(t)?t:[t];for(let e of n){let t=this._components.indexOf(e);if(t<0)return;this._components.splice(t,1)}e.emit(document,"snorkel:components-removed",{snorkel:this,components:n})},p.install=function(n,o){!function(n,o={}){e=n,t=o.diff}(n,o),e.emit(document,"snorkel:ready")},"undefined"!=typeof window&&window.Reef&&window.Reef.use(p),module.exports=p;
